<!DOCTYPE html>
<html>
<meta charset="UTF-8">    

<head>
    <link rel="stylesheet" href="styles.css">
    <title>Co2 aftryk gennem maden</title>
	<script type="text/javascript" src="d3.js"></script>
    <style>

    </style>
</head>
<div class="boxed">
    <h1>Co2 aftryk gennem Ahmads røvhul</h1>
</div>

<body>
    <script>
        let kategori = ["brød", "fisk", "frugt", "krydderier", "grøntsager", "kød", "mejeri"];
        let brød_varer = ["rugbrød", "burgerboller", "toastbrød", "granolabar", "chokoladekage", "pizza", "pasta"];
        let fisk_varer = ["tun i vand", "ørred", "laks", "makrel", "sild", "torsk"];
        let frugt_varer = ["avokado", "banan", "citron", "vandmelon", "appelsin", "ananas"];
        let krydderi_varer = ["makrelsalat", "salt", "remoulade", "okseboullion", "sort peber", "tomatketchup", "vegansk mayo"];
        let grøntsags_varer = ["rød peber", "agurk", "hvidløg", "broccoli", "spinat", "iceberg salat", "svampe", "kartofler", "gullerødder", "løg"];
        let kød_varer = ["oksefillet", "hakket oksekød", "t-bone steak", "bacon", "svinepølse", "kyllingepølse", "hakket svinekød", "kalvekød", "hakket kyllingekød", "hel kylling"];
        let mejeri_varer = ["smør", "skyr", "ost", "æg", "havremælk", "soyamælk", "skummetmælk", "kakao, skummetmælk", "vegansk smør", "vegansk ost"];</script>

    <label for="lang">Kategori</label>
    <br>
    <select id="selectNumber">
        <option>Vælg kategori</option>
    </select>
    <section class="p-menu1">
        <nav id="navbar" class="navigation" role="navigation">
          <input id="toggle1" type="checkbox">
          <label class="hamburger1" for="toggle1">
            <div class="top"></div>
            <div class="meat"></div>
            <div class="bottom"></div>
          </label>
    
          <nav class="menu1">
            <a class="link1" href="">Projektstyring</a>
            <a class="link1" href="">Dataforståelse</a>
            <a class="link1" href="">Visualisering</a>
            <a class="link1" href="">Webteknologi</a>
          </nav>
        </nav>
      </section>

    </select>
    <br>
    <label for="lang">Ingrediens</label>
    <br>
    <select id="selectNumber">
        <option>Vælg ingrediens</option>
    </select>

    <h4> Sammenligning af din valgte ret med fire populære retter: </h4>
    <p>&#129385;</p>

    <script>
    
    // Foruddefinerer variabler som globale 
    let yScale = 0;
    let data = [];
    let xScale;
    let Lastbil;
    let svg;
    let paths;

    d3.json("/postgresql/query", {
      method: "POST",
      body: `SELECT T.type, A.aarstal, CAST((C.antal_km * T.co2_km)/100000 AS bigint) AS co2udslip
                  FROM public."Co2" AS C
                  INNER JOIN public."Transportmidler" AS T ON C.transportmiddel_id = T.transportmiddel_id
                  INNER JOIN public."Tid" AS A ON C.tid_id = A.tid_id 
                  ORDER BY T.transportmiddel_id ASC, A.tid_id;`
    }).then(function (response) {
      const gammelData = response.data;
      console.log("data", gammelData);

      // Definere start og slut år på visualisering
      let retter = 0;
      let slutretter = 5;

      // Danner nyt array af objekter så datasæt brugbart til d3.js med multi-line chart
      for (let ret = retter; ret <= slutretter; ret++) {
        data.push({ "retter": ret })
        for (let i in gammelData) {
          if (gammelData[i].aarstal == ret) {
            data[ret - retter][gammelData[i].type] = gammelData[i].co2udslip
          };
        };
      };

      // Definerer margin, højde og bredde på SVG
      var margin = { "top": 20, "right": 20, "bottom": 30, "left": 75 },
        w = 750,
        h = 300;

      // Danner xScale
      xScale = d3.scaleTime()
        .range([0, w - margin.right * 2])
        .domain(d3.extent(data, function (d) { return new Date(parseInt(d.aarstal), 0); }));

      // Danner yScale
      yScale = d3.scaleLinear()
        .range([h, 0 + margin.top])
        .domain([0, d3.max(data, function (d) { return Math.max(d.Lastbil) / 0.8; })]);

      // Opretter lastbil-linje
      Lastbil = d3.line()
        .x(function (d) { return xScale(new Date(parseInt(d.aarstal), 0)); })
        .y(function (d) { return yScale(d.Lastbil); });

      // Tilføjer svg til body
      // Tilføjer 'g'/'gruppe' element til svg
      // Flytter 'g' til top venstre margin
      svg = d3.select("body")
        .append("svg")
        .attr("class", "chart")
        .attr("width", w + margin.left + margin.right)
        .attr("height", h + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left * 1.5 + "," + margin.top + ")");

      // Indsætte første path (lastbiler)
      svg.append("path")
        .datum(data)
        .transition().duration(1000)
        .attr("id", "Lastbil")
        .attr("class", "line")
        .style("stroke", "red")
        .attr("d", Lastbil);

      // Indsætter lastbil til "eksisterende path array" som objekt
      paths = [{ "type": "Lastbil", "liste": Lastbil }];

      // Indsætter X aksen
      svg.append("g")
        .attr("transform", "translate(0," + h + ")")
        .call(d3.axisBottom(xScale)
          .tickFormat(d3.timeFormat("%Y"))
          .ticks(data.length));

      // Indsætter Y aksen
      svg.append("g")
        .attr("id", "y-akse")
        .call(d3.axisLeft(yScale).ticks(6));

      // Tilføjer titel til Y akse
      svg.append("text")
        .attr("class", "y-title")
        .attr("x", -margin.left - 20)
        .attr("y", -margin.left)
        .attr("transform", `rotate(-90)`)
        .style("font-size", "12px")
        .text("CO2 I TON");

      // Tilføjer titel til X akse
      svg.append("text")
        .attr("class", "x-title")
        .attr("x", 0)
        .attr("y", h + margin.bottom)
        .style("font-size", "12px")
        .text("ÅRSTAL");

      var xScale2019 = new Date(parseInt(2019), 0)
      // Tilføjer corona Linje - er ved ultimo 2019
      svg.append('line')
        .attr("class", "danger-line")
        .attr("x1", 568)
        .attr("y1", 22)
        .attr("x2", 568)
        .attr("y2", 300)
        .style("stroke-dasharray", ("5, 5"))

      // Tilføjer titel til covid-linje
      svg.append("text")
        .attr("class", "corona-title")
        .attr("x", (xScale(xScale2019)))
        .attr("y", (margin.top))
        .attr("text-anchor", "middle")
        .style("font-size", "12px")
        .text("COVID-19")
        .attr("fill", "red")
        .attr("font-weight", "Bold");
    })

    function addLine(vehicle, color) {
      // Opdater yScale
      yScale.domain([0, d3.max(data, function (d) { return Math.max(d[vehicle]) / 0.8; })]);

      // Definerer ny path til indsættelse
      var valueline = d3.line()
        .x(function (d) { return xScale(new Date(parseInt(d.aarstal), 0)); })
        .y(function (d) { return yScale(d[vehicle]); });

      // Opdaterer Y aksen med scaling
      svg.select("#y-akse")
        .transition()
        .duration(1500)
        .call(d3.axisLeft(yScale).ticks(6));

      // Opdaterer scaling på alle eksisterende paths
      for (let path of paths) {
        svg.select(`path#${path.type}`)
          .transition()
          .duration(1500)
          .attr("d", path.liste);
      };

      // Hvis path ikke findes, så indsættes nye path
      // Hvis path allerede findes, så gør ingenting
      // index = -1 hvis path ikke allerede findes; index-nummer i array hvis path findes
      // if (index === -1) => true - hvis index = -1 / false - hvis index >= 0
      var index = paths.findIndex(x => x.type == vehicle);
      if (index === -1) {
        svg.append("path")
          .datum(data)
          .attr("opacity", 0)
          .transition().delay(1500).duration(1000)
          .attr("class", "line")
          .attr("id", vehicle)
          .style("stroke", color)
          .attr("d", valueline)
          .duration(500)
          .attr("opacity", 1)
      }

      // Hvis path ikke allerede eksisterer, så push path data ind til array
      // Hvis path allerede findes, så pushes ikke til array
      if (index === -1) {
        paths.push({ "type": vehicle, "liste": valueline });
      }
    };

    function removePath(id) {
      // Function anvendes til at fjerne eksisterende path ved button click
      // Fjerner element fra DOM og objekt fra array: paths
      document.getElementById(id).remove();
      index = paths.findIndex(x => x.type === id);
      paths.splice(index, 1);
    };

  
    </script>
<table>
    <tr>
      <th>Ingrediens</td>
      <th>Mængde</td>
      <th>Udledt Co2</td>
      <th>Co2 udledt i alt</td>
    </tr>
    <tr>
      <td>Oksekød</td>
      <td>500g</td>
      <td>25kg</td>
      <td>25kg</td>
    </tr>
    <tr>
        <td>Oksekød</td>
        <td>500g</td>
        <td>25kg</td>
        <td>25kg</td>
      </tr>
      <tr>
        <td>Oksekød</td>
        <td>500g</td>
        <td>25kg</td>
        <td>25kg</td>
      </tr>
      <tr>
        <td>Oksekød</td>
        <td>500g</td>
        <td>25kg</td>
        <td>25kg</td>
      </tr>
      <tr>
        <td>Oksekød</td>
        <td>500g</td>
        <td>25kg</td>
        <td>25kg</td>
      </tr>
      <tr>
        <td>Oksekød</td>
        <td>500g</td>
        <td>25kg</td>
        <td>25kg</td>
      </tr>
  </table>
</body>



</html>